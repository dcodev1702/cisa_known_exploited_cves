#!/usr/bin/env python3

'''
Authors: Lorenzo J. Ireland, ChatGPT-4, and Co-Pilot
Date: 2023-03-25

Purpose: This script will download the latest CISA CVE Catalog JSON file from 
the Internet and save it to /var/log/cisa_cveids/cveids-oneliner.log. From there, it will
check if the catalog version has changed. If it has, it will update the file with the latest.

Usage: This script is intended to be run by a cron job every 24 hours.
'''
import json
import os
import requests
import pwd
import grp

CISA_CVE_JSON_FILE = '/var/log/cisa_cveids/cveids-oneliner.log'

def get_cisa_json():
    
    print (f"Downloading CISA CVE Catalog now...")

    url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    response = requests.get(url)

    if response.status_code == 200:
        loaded_json = response.json()
        cisa_http_json = json.dumps(loaded_json, separators=(',', ':'))
        return cisa_http_json
    else:
        print(f"Error downloading JSON data: {response.status_code}")
        return None


def main():

    # Pull latest CISA CVE Catalog from the Internet
    cisa_http_json = get_cisa_json()

    # Check if the CISA CVE Catalog JSON file exists at /var/log/cisa_cveids/cveids-oneliner.log
    if not os.path.isfile(CISA_CVE_JSON_FILE):
        print (f"CISA Catalog CVE JSON does not exist.\n")

        if cisa_http_json:
            output_file_path = os.path.join("/var/log/cisa_cveids/", "cveids-oneliner.log")
            with open(output_file_path, 'w') as output_file:
                output_file.write(cisa_http_json)

            user_name = 'logstash'
            group_name = 'logstash'

            uid = pwd.getpwnam(user_name).pw_uid
            gid = grp.getgrnam(group_name).gr_gid
            os.chown(output_file_path, uid, gid)

            print(cisa_http_json)
        else:
            print("This env does not have access to the Internet ..quitting.\n")
            exit(1)

    else:

        # Load the CISA CVE Catalog JSON file   
        cisa_http_json_obj = json.loads(cisa_http_json)
        
        # Extract the catalogVersion field from the JSON object
        catalog_version_http = cisa_http_json_obj['catalogVersion']

        with open(CISA_CVE_JSON_FILE, 'r') as data:
            json_data_onFile = json.load(data)

        # Extract the catalogVersion field from the JSON object on file (/var/log/cisa_cveids/cveids-oneliner.log)
        catalog_version_onFile = json_data_onFile['catalogVersion']

        # Testing to see if the catalog version from CISA is newer than the one on file
        if catalog_version_http > catalog_version_onFile:
            print(f"Current catalog version on file: \"{catalog_version_onFile}\"")
            print(f"A new catalog version \"{catalog_version_http}\" is available, applying updated CISA CVE catalog!")
            
            output_file_path = os.path.join("/var/log/cisa_cveids/", "cveids-oneliner.log")
            with open(output_file_path, 'w') as output_file:
                output_file.write(cisa_http_json)
        else:
            print(f"The catalog version \"{catalog_version_onFile}\" has not changed, no update to apply at this time.")


if __name__ == "__main__":
    main()
